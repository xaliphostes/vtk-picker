<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>vtk.js + ScenePicker (UMD bundle) Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: system-ui, Arial, sans-serif;
        }

        #app {
            position: relative;
            height: 100%;
        }

        #ui {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
            background: rgba(255, 255, 255, .95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .15);
            width: 290px;
        }

        #ui h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #0a58ca;
        }

        .row {
            margin: 8px 0;
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: #333;
        }

        select {
            width: 100%;
            padding: 6px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        #info {
            position: absolute;
            left: 12px;
            bottom: 12px;
            z-index: 10;
            background: rgba(255, 255, 255, .95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .15);
            width: 420px;
            font-size: 13px;
        }

        #info b {
            color: #333;
        }

        #info .kv {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 4px 10px;
        }

        #hint {
            position: absolute;
            right: 12px;
            top: 12px;
            z-index: 10;
            background: rgba(10, 88, 202, .95);
            color: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            width: 260px;
        }

        #hint ul {
            margin: 6px 0 0 16px;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <div id="ui">
        <h3>Picker settings</h3>
        <div class="row grid">
            <div>
                <label for="pickerType">Picker type</label>
                <select id="pickerType">
                    <option value="cell">Cell (vtkCellPicker)</option>
                    <option value="point">Point (vtkPointPicker)</option>
                    <!-- <option value="prop">Prop (vtkPropPicker)</option> -->
                </select>
            </div>
            <div>
                <label for="mouseBtn">Mouse button</label>
                <select id="mouseBtn">
                    <option value="left">Left</option>
                    <option value="middle">Middle</option>
                    <option value="right">Right</option>
                </select>
            </div>
        </div>
        <div class="row">
            <label for="modifier">Required modifier</label>
            <select id="modifier">
                <option value="none">None (always active)</option>
                <option value="shift">Shift</option>
                <option value="ctrl">Ctrl</option>
                <option value="alt">Alt</option>
                <option value="meta">Meta/Cmd</option>
            </select>
        </div>
    </div>

    <div id="info">
        <div><b>Status:</b> <span id="status">ready</span></div>
        <div class="kv" style="margin-top:6px;">
            <div><b>Actor:</b></div>
            <div id="actor">–</div>
            <div><b>Screen:</b></div>
            <div id="screen">–</div>
            <div><b>World:</b></div>
            <div id="world">–</div>
            <div><b>Cell ID:</b></div>
            <div id="cell">–</div>
            <div><b>Point ID:</b></div>
            <div id="point">–</div>
            <div><b>Modifiers:</b></div>
            <div id="mods">–</div>
            <div><b>Button:</b></div>
            <div id="btn">–</div>
        </div>
    </div>

    <div id="hint">
        <b>How to use</b>
        <ul>
            <li>Choose picker type / mouse button</li>
            <li>Optionally require a key (Shift/Ctrl/Alt/Meta)</li>
            <li>Click in the scene to pick objects</li>
        </ul>
    </div>

    <script type="module">
        import '@kitware/vtk.js/Rendering/Profiles/Geometry';
        import vtkFullScreenRenderWindow from '@kitware/vtk.js/Rendering/Misc/FullScreenRenderWindow';
        import vtkActor from '@kitware/vtk.js/Rendering/Core/Actor';
        import vtkCellPicker from '@kitware/vtk.js/Rendering/Core/CellPicker';
        import vtkPointPicker from '@kitware/vtk.js/Rendering/Core/PointPicker';
        // import vtkPropPicker from '@kitware/vtk.js/Rendering/Core/PropPicker';
        import vtkMapper from '@kitware/vtk.js/Rendering/Core/Mapper';
        import vtkConeSource from '@kitware/vtk.js/Filters/Sources/ConeSource';
        import vtkSphereSource from '@kitware/vtk.js/Filters/Sources/SphereSource';
        import vtkCylinderSource from '@kitware/vtk.js/Filters/Sources/CylinderSource';

        import { ScenePicker } from './src/ScenePicker.ts';

        // --- VTK setup ----------------------------------------------------------
        const fs = vtkFullScreenRenderWindow.newInstance({
            rootContainer: document.body,
            containerStyle: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0 },
        });

        const renderer = fs.getRenderer();
        const renderWindow = fs.getRenderWindow();
        const interactor = fs.getInteractor();

        // Helpers
        const Actor = vtkActor;
        const Mapper = vtkMapper;
        const ConeSource = vtkConeSource;
        const SphereSource = vtkSphereSource;
        const CylinderSource = vtkCylinderSource;

        // Scene: cone, sphere, cylinder
        function makeActorFrom(source, color, position, edgesVisible) {
            const mapper = Mapper.newInstance();
            mapper.setInputConnection(source.getOutputPort());

            const actor = Actor.newInstance();
            actor.setMapper(mapper);

            const prop = actor.getProperty();
            prop.setColor(...color);
            prop.setRepresentationToSurface();     // keep shaded surface
            if (edgesVisible) {
                prop.setEdgeVisibility(true);          // draw edges on top
                prop.setEdgeColor(0, 0, 0);            // wireframe (edge) color
                prop.setLineWidth(1.5);                // edge thickness (browser/GPU dependent)
            }

            actor.setPosition(...position);
            return actor;
        }

        const cone = makeActorFrom(ConeSource.newInstance({ height: 1, radius: 0.5, resolution: 40 }), [1, .35, .35], [-1.5, 0, 0]);
        const sphere = makeActorFrom(SphereSource.newInstance({ radius: 0.55, phiResolution: 32, thetaResolution: 32 }), [.35, 1, .35], [0, 0, 0], true);
        const cyl = makeActorFrom(CylinderSource.newInstance({ height: 1.1, radius: 0.35, resolution: 40 }), [.35, .35, 1], [1.5, 0, 0]);

        renderer.addActor(cone);
        renderer.addActor(sphere);
        renderer.addActor(cyl);
        renderer.resetCamera();
        renderWindow.render();

        // --- Picker wiring ------------------------------------------------------

        const CellPicker = vtkCellPicker;
        const PointPicker = vtkPointPicker;
        //const PropPicker = vtk.Rendering.Core.vtkPropPicker;

        const ui = {
            pickerType: document.getElementById('pickerType'),
            mouseBtn: document.getElementById('mouseBtn'),
            modifier: document.getElementById('modifier'),
            status: document.getElementById('status'),
            actor: document.getElementById('actor'),
            screen: document.getElementById('screen'),
            world: document.getElementById('world'),
            cell: document.getElementById('cell'),
            point: document.getElementById('point'),
            mods: document.getElementById('mods'),
            btn: document.getElementById('btn'),
        };

        let scenePicker = null;
        let currentPicker = null;

        function requiredModsFromUI() {
            const v = ui.modifier.value;
            return {
                shift: v === 'shift' || undefined,
                ctrl: v === 'ctrl' || undefined,
                alt: v === 'alt' || undefined,
                meta: v === 'meta' || undefined,
            };
        }

        function newVtkPicker(kind) {
            if (kind === 'cell') return CellPicker.newInstance();
            if (kind === 'point') return PointPicker.newInstance();
            // return PropPicker.newInstance();
        }

        function resetInfo() {
            ui.status.textContent = 'ready';
            ui.actor.textContent = '–';
            ui.screen.textContent = '–';
            ui.world.textContent = '–';
            ui.cell.textContent = '–';
            ui.point.textContent = '–';
            ui.mods.textContent = '–';
            ui.btn.textContent = '–';
        }

        function describeActor(a) {
            if (!a) return '–';
            if (a === cone) return 'Cone (red)';
            if (a === sphere) return 'Sphere (green)';
            if (a === cyl) return 'Cylinder (blue)';
            return 'Actor';
        }

        function rebuildPicker() {
            // cleanup
            if (scenePicker && scenePicker.dispose) scenePicker.dispose();

            currentPicker = newVtkPicker(ui.pickerType.value);
            scenePicker = new ScenePicker(interactor, currentPicker, {
                button: ui.mouseBtn.value,
                requireModifiers: (function () {
                    const v = ui.modifier.value;
                    const req = {};
                    if (v === 'shift') req.shift = true;
                    if (v === 'ctrl') req.ctrl = true;
                    if (v === 'alt') req.alt = true;
                    if (v === 'meta') req.meta = true;
                    return req;
                })(),
            });

            scenePicker.onPick((ev) => {
                // Screen coords
                ui.screen.textContent = `${ev.displayPos[0].toFixed(1)}, ${ev.displayPos[1].toFixed(1)}`;
                ui.mods.textContent = [
                    ev.modifiers.shift ? 'Shift' : null,
                    ev.modifiers.ctrl ? 'Ctrl' : null,
                    ev.modifiers.alt ? 'Alt' : null,
                    ev.modifiers.meta ? 'Meta' : null,
                ].filter(Boolean).join('+') || 'none';
                ui.btn.textContent = ev.button;

                if (!ev.picked) {
                    ui.status.textContent = 'no hit';
                    ui.actor.textContent = '–';
                    ui.world.textContent = '–';
                    ui.cell.textContent = '–';
                    ui.point.textContent = '–';
                    return;
                }

                // Use normalized values exposed by ScenePicker
                const a = ev.actor;
                const w = ev.world;
                ui.status.textContent = 'hit';
                ui.actor.textContent = a ? describeActor(a) : '–';
                ui.world.textContent = w ? `${w[0].toFixed(3)}, ${w[1].toFixed(3)}, ${w[2].toFixed(3)}` : '–';

                // Only show valid IDs (>= 0). Some pickers never set one of them.
                ui.cell.textContent = (typeof ev.cellId === 'number' && ev.cellId >= 0) ? ev.cellId : '–';
                ui.point.textContent = (typeof ev.pointId === 'number' && ev.pointId >= 0) ? ev.pointId : '–';
            });

            resetInfo();
        }

        // Initial picker
        rebuildPicker();

        // UI handlers
        ui.pickerType.addEventListener('change', rebuildPicker);
        ui.mouseBtn.addEventListener('change', rebuildPicker);
        ui.modifier.addEventListener('change', rebuildPicker);

        // Resize render window with the canvas
        window.addEventListener('resize', () => {
            renderWindow.render();
        });
    </script>
</body>

</html>